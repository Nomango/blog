---
title: åŸºäº Github Workflow çš„ Web æœåŠ¡ CICD æ–¹æ¡ˆ
date: 2023-12-26 20:47:00
tags: [Github Workflow, DevOps]
description: ä»‹ç»ä¸€ä¸‹ç°åœ¨æœ€ğŸ”¥çš„ CICD å¹³å°çš„ä¸€äº›ä½¿ç”¨æŠ€å·§
---

::toc

# ä»€ä¹ˆæ˜¯ CICD

`CICD` çš„ä¸­æ–‡ç¿»è¯‘æ˜¯ **æŒç»­é›†æˆï¼ŒæŒç»­éƒ¨ç½²**ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨ç¨‹åºå‘˜ä»¬æ¯å¤©ä¸æ–­çš„åˆå¹¶ä»£ç æ—¶ï¼Œæœ‰ä¸€ä¸ªç³»ç»Ÿå¯ä»¥è‡ªåŠ¨å¯¹åˆå…¥çš„ä»£ç è¿›è¡Œå„ç§æµ‹è¯•ï¼Œä»¥ä¿è¯åˆå…¥ä»£ç æ²¡æœ‰å¯¹æœåŠ¡é€ æˆç ´åï¼Œç„¶åè‡ªåŠ¨åŒ–åœ°æ„å»ºäº§ç‰©ï¼ˆæ¯”å¦‚ Docker é•œåƒã€ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œå¹¶å®Œæˆè‡ªåŠ¨åŒ–éƒ¨ç½²ç­‰ç­‰ã€‚

ä¸€ä¸ªæ¯”è¾ƒæœ‰åçš„ CICD ç³»ç»Ÿæ˜¯ `Jenkins`ï¼Œå®ƒé€šè¿‡ Pipeline å®šä¹‰å·¥ä½œæµï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ä»»åŠ¡æ¨¡æ¿ï¼Œå¼ºå¤§åˆçµæ´»ã€‚ Jenkins é€šå¸¸éœ€è¦å¼€å‘è€…è‡ªè¡Œéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ç§æœ¬åœ° CICD æ–¹æ¡ˆã€‚

å› æ­¤ä¹Ÿæœ‰ä¸€äº›ä¸“é—¨åšäº‘ä¸Š CICD çš„å¹³å°ï¼Œæ¯”å¦‚ [`Travis CI`](https://www.travis-ci.com/)ã€[`AppVeyor`](https://www.appveyor.com/) ç­‰ã€‚æˆ‘ä»¬è¦ä»‹ç»çš„ `Github Workflow` ä¹Ÿæ˜¯ä¸€ç§äº‘ä¸Š CICD å¹³å°ï¼Œå®ƒæœ€å¤§çš„ä¼˜åŠ¿æ˜¯å¤©ç„¶çš„å’Œ Github ç»‘å®šï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°ä½¿ç”¨ä»–äººå¼€å‘çš„ `Github Actions`ã€‚

# ä¸€ä¸ªç®€å•çš„ Workflow

```yaml title=".github/workflows/build.yaml" {14-17}
name: Build frontend
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # å®‰è£… node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 18

      # æ„å»º
      - run: |
          npm i
          npm build

      # å°† ./dist äº§ç‰©ä¸Šä¼ åˆ°æœåŠ¡å™¨
      # ...
```

åªéœ€è¦å°†è¿™ä¸ªæ–‡ä»¶æ”¾åˆ° Github ä»“åº“ä¸­ï¼Œå®ƒå°±ä¼šåœ¨æ¯æ¬¡ä¸»åˆ†æ”¯æœ‰æäº¤æ—¶è¿è¡Œï¼Œè¿˜å¯ä»¥åœ¨ `Actions` é€‰é¡¹å¡çœ‹åˆ°è¿è¡Œæƒ…å†µï¼š

![Github Actions](@assets/github-workflow-cicd/image.png)

æœ¬æ–‡ä¸æ˜¯ Github Workflow çš„ä½¿ç”¨æ•™ç¨‹ï¼Œæ‰€ä»¥ä¸å†ä»‹ç»åŸºæœ¬çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥åˆ°[å®˜ç½‘](https://docs.github.com/en/actions/using-workflows)æŸ¥çœ‹å®Œæ•´çš„æ•™ç¨‹ã€‚

# CICD è®¾è®¡æ€è·¯

ä¸ºä¸€ä¸ªåŒç¯å¢ƒç³»ç»Ÿè®¾è®¡ä¸€å¥— CICDï¼ŒåŒç¯å¢ƒæ˜¯æŒ‡æœ‰ä¸€ä¸ª `Production` çº¿ä¸Šç”Ÿäº§ç¯å¢ƒï¼Œè¿˜æœ‰ä¸€ä¸ª `Testing` æµ‹è¯•ç¯å¢ƒã€‚è¿™å¥— CICD çš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š

```mermaid
%%{init: {'theme':'neutral'}}%%
graph LR
  A[Git Push] --> B[å•å…ƒæµ‹è¯•]
  B --> C[æ„å»ºäº§ç‰©]
  C -.-> |è‡ªåŠ¨éƒ¨ç½²| E1(æµ‹è¯•ç¯å¢ƒ)
  C -.-> |è‡ªåŠ¨éƒ¨ç½²| E2(ç”Ÿäº§ç¯å¢ƒ)
```

æ¯ä¸ªä»£ç ä»“åº“æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªä¸»åˆ†æ”¯ï¼Œä¸»åˆ†æ”¯å¯¹åº” Testing ç¯å¢ƒï¼Œå½“ Git æ¨é€ commit æˆ–åˆå¹¶ PR æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œå•å…ƒæµ‹è¯•ã€é•œåƒæ„å»ºï¼Œå¹¶æœ€ç»ˆå‘å¸ƒåˆ° Testing ç¯å¢ƒã€‚å½“ Git æ¨é€ tag æ—¶ï¼Œæ„å»ºçš„äº§ç‰©å°†ä¼šè‡ªåŠ¨éƒ¨ç½²çš„ Production ç¯å¢ƒã€‚

è¿™é‡Œçš„æ„å»ºäº§ç‰©è™½ç„¶å¯ä»¥æ˜¯å‰ç«¯çš„ `dist` æ–‡ä»¶ï¼Œæˆ–è€…åç«¯çš„ `bin` å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ›´å¥½çš„æ–¹æ³•æ˜¯é€šè¿‡é•œåƒå’Œå®¹å™¨æ¥ç®¡ç†æˆ‘ä»¬çš„æœåŠ¡ï¼Œé€šè¿‡é•œåƒç‰ˆæœ¬æ¥ç®¡ç†æˆ‘ä»¬çš„æœåŠ¡ç‰ˆæœ¬ã€‚å¯¹äºäº§ç‰©æ˜¯é•œåƒçš„æœåŠ¡ï¼Œå®ƒçš„ä¸€ä¸ªç®€å• CICD æµç¨‹å¯ä»¥å¦‚ä¸‹ï¼š

```mermaid
%%{init: {'theme':'neutral'}}%%
graph LR
  A[Git Push] --> |commit| B[å•å…ƒæµ‹è¯•]
  B --> C[æ„å»º dev é•œåƒ]
  C -.-> |è‡ªåŠ¨éƒ¨ç½²| E1(æµ‹è¯•ç¯å¢ƒ)
  A --> |tag| D[å‘å¸ƒé•œåƒ]
  C -.-> |re-tag| D
  D -.-> |æ‰‹åŠ¨éƒ¨ç½²| E2(ç”Ÿäº§ç¯å¢ƒ)
```

æ³¨æ„è¿™é‡Œçš„ dev é•œåƒç‰ˆæœ¬å¯ä»¥æ˜¯ `commit sha`ï¼Œå¦‚ `server:411f38c`ã€‚æ¨é€ tag æ—¶ï¼Œæ ¹æ® tag å¯¹åº”çš„ `commit sha` æ‹‰å–ä¹‹å‰æ„å»ºå¥½çš„é•œåƒï¼Œå¹¶é‡æ–°æ‰“ä¸Šæ ‡ç­¾ï¼Œå¦‚ `server:1.0.0`ï¼Œå¹¶æœ€ç»ˆæ‰‹åŠ¨éƒ¨ç½²åˆ° Production ç¯å¢ƒã€‚

# CICD on Github Workflow

ç”±äº Github Workflow è®¾è®¡ä¸Šçš„çµæ´»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æ¯éƒ¨åˆ†æ‹†è§£æ¥çœ‹å®ç°æ–¹å¼ã€‚

## è‡ªåŠ¨åŒ–æµ‹è¯•

```yaml title=".github/workflows/test.yaml" {24-26}
name: Unit Testing

on:
  push:
    branches: [main, master] # æ¨é€åˆ°åˆ†æ”¯æ—¶è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      # åœ¨ Action è¿è¡Œç¯å¢ƒä¸­æ‹‰å–å½“å‰ä»“åº“çš„ä»£ç 
      - name: Checkout
        uses: actions/checkout@v3

      # æ‰§è¡Œå®é™…çš„æµ‹è¯•ä»£ç ï¼Œå¦‚æ‰§è¡Œ go è¯­è¨€å•å…ƒæµ‹è¯•
      # è¿™é‡Œåªæ˜¯æœ€ç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œå®é™…è¦æ ¹æ®æƒ…å†µé…ç½®ä¾èµ–
      # å¦‚ private modules æƒé™ã€åŠ¨æ€ç”Ÿæˆçš„å¦‚ protobuf æ–‡ä»¶ã€cache ç­‰

      # å®‰è£… go
      - uses: actions/setup-go@v3
        with:
          go-version: 1.19.x

      # è¿è¡Œå•å…ƒæµ‹è¯•
      - run: |
          go test -race -failfast -count=1 -gcflags=all=-l ./...
```

## è‡ªåŠ¨åŒ–æ„å»º

```yaml title=".github/workflows/build.yaml" {19-26} {47-54}
name: Build Image

on:
  push:
    branches: [main, master] # æ¨é€åˆ°åˆ†æ”¯æ—¶è¿è¡Œ

concurrency: # é™åˆ¶ Build Workflow ä¸å¹¶å‘
  group: build-${{ github.sha }}

env:
  # æ ¹æ®å®é™…æƒ…å†µé…ç½®ä½ çš„ image hub
  REGISTRY: YOUR_REGISTRY
  REPO_NAME: YOUR_REPO

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      # æˆªå– github.sha å˜é‡çš„å‰ 7 ä½ä½œä¸ºé•œåƒç‰ˆæœ¬
      - id: get_version
        name: Get image version
        run: |
          IMAGE_VERSION=${{ github.sha }}
          IMAGE_VERSION=${IMAGE_VERSION: 0: 7}
          echo ${IMAGE_VERSION}
          echo "IMAGE_VERSION=${IMAGE_VERSION}" >> $GITHUB_ENV

      # åœ¨ Action è¿è¡Œç¯å¢ƒä¸­æ‹‰å–å½“å‰ä»“åº“çš„ä»£ç 
      - name: Checkout
        uses: actions/checkout@v3

      # å®‰è£… Docker Build å·¥å…·åŒ…
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # ç™»å½•åˆ° Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # ä½¿ç”¨ ./Dockerfile ç¼–è¯‘ã€æ‰“åŒ…å¹¶æ¨é€
      - name: Build and push
        uses: docker/build-push-action@v3
        with:
          context: .
          build-args: VERSION=${{ env.IMAGE_VERSION }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO_NAME }}:${{ env.IMAGE_VERSION }}
```

ä»£ç ä»“åº“ä¸‹éœ€è¦æ·»åŠ ä¸€ä¸ª Dockerfile æ–‡ä»¶ï¼Œæ¥ç¼–å†™æœåŠ¡ç¼–è¯‘è„šæœ¬ï¼Œä¾‹å¦‚ä¸€ä¸ªç®€å•çš„å‰ç«¯æœåŠ¡ï¼š

```dockerfile title="Dockerfile"
FROM node:18-alpine as builder

ADD . /app
WORKDIR /app

RUN npm i && npm build

# Copy distribution to a clean stage
FROM node:18-alpine

COPY --from=builder /app/dist /app/

ENV HOST 0.0.0.0
EXPOSE 8080

ENTRYPOINT ["node", "/app/index.js"]
```

## è‡ªåŠ¨åŒ–éƒ¨ç½²

ä¸€ä¸ªæœ€ç®€å•çš„ä½¿ç”¨ SSH ç™»å½•åˆ°æœåŠ¡å™¨ï¼Œå¹¶æ‰§è¡Œå‡çº§æœåŠ¡è„šæœ¬çš„ Workflowï¼š

```yaml title=".github/workflows/deploy.yaml" {31}
name: Deploy

on:
  # æ”¯æŒæ‰‹åŠ¨éƒ¨ç½²
  workflow_dispatch:
    inputs:
      service:
        description: "The service you want to deploy"
        required: true
        type: string
      version:
        description: "The service version you want to deploy"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-20.04
    steps:
      # ä½¿ç”¨ SSH ç™»å½•åˆ°æœåŠ¡å™¨
      - name: Deploy ${{ inputs.service }}@${{ inputs.version }}
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          # æ‰§è¡Œå®é™…çš„éƒ¨ç½²è„šæœ¬ï¼Œå¦‚éƒ¨ç½² docker service
          script: |
            sudo docker service update --image ${{ inputs.version }} ${{ inputs.service }}
```

> å…³äº Docker Service çš„æ•™ç¨‹å¯ä»¥å‚è€ƒ[æˆ‘çš„è¿™ç¯‡æ–‡ç« ](/posts/docker-swarm-deploy)ã€‚

å½“ç„¶å®é™…æƒ…å†µè‚¯å®šæ¯”è¿™ä¸ªè¦å¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ­¥ä¸€æ­¥è§£å†³å®é™…å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚

## ç®¡ç†é…ç½®æ–‡ä»¶

æœåŠ¡å‡çº§è‚¯å®šä¸åªæ˜¯å‡çº§æœåŠ¡çš„ç¨‹åºï¼Œè¿˜è¦è€ƒè™‘å®ƒéœ€è¦çš„é…ç½®æ–‡ä»¶ï¼Œä»¥åŠä¸åŒç¯å¢ƒå¦‚ä½•ä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚

å¦‚æœä½ ä½¿ç”¨ `k8s` ç®¡ç†æœåŠ¡ï¼Œé‚£ä¹ˆä½ ä¸éœ€è¦å…³æ³¨è¿™ä¸ªç« èŠ‚ï¼Œå› ä¸º `ConfigMap` å·²ç»æ›¿ä½ åšäº†å¤§éƒ¨åˆ†å·¥ä½œã€‚

å¦‚æœä½ ä½¿ç”¨ Github ä»“åº“æ¥ç®¡ç†é…ç½®æ–‡ä»¶ï¼Œé‚£ä¹ˆå¯ä»¥ç»™æœåŠ¡å™¨å®‰è£… Gitï¼Œé€šè¿‡ `git pull` æ‹‰å–æœ€æ–°çš„é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

```yaml title=".github/workflows/deploy.yaml" {9-11}
steps:
  # ä½¿ç”¨ SSH ç™»å½•åˆ°æœåŠ¡å™¨
  - name: Deploy
    uses: appleboy/ssh-action@v0.1.10
    with:
      script: |
        cd /path/to/your/repo
        # æ‹‰å–æœ€æ–°é…ç½®
        git fetch
        git reset --hard ${{ github.sha }}
        git clean -xdf
        # æ‰§è¡Œå®é™…çš„éƒ¨ç½²è„šæœ¬
        sudo docker service update --image ${{ inputs.version }} ${{ inputs.service }}
```

ç„¶è€Œè¿™éœ€è¦æœåŠ¡å™¨å…·æœ‰è®¿é—®ä½ çš„ Github Repo çš„æƒé™ï¼Œå¹¶ä¸”åŒä¸€ä»“åº“ä¸‹å…·æœ‰å¤šä¸ªæœåŠ¡æ—¶ï¼Œ`git pull` ä¼šæ›´æ–°åˆ°å…¶ä»–åŸæœ¬ä¸æƒ³æ›´æ–°çš„æ–‡ä»¶ï¼Œè¿˜ä¼šå‡ºç°å¹¶å‘é—®é¢˜å¯¼è‡´éƒ¨ç½²å¤±è´¥ã€‚

æ‰€ä»¥ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨ `Docker Config` ç®¡ç†é…ç½®æ–‡ä»¶ï¼Œå®ƒå¯ä»¥å°†é…ç½®æ–‡ä»¶æ ‡è®°ç‰ˆæœ¬å·ï¼Œä»¥ä¾¿å°†é•œåƒç‰ˆæœ¬å’Œé…ç½®æ–‡ä»¶ç‰ˆæœ¬ç»‘å®šèµ·æ¥æ›´æ–°ã€‚å…³äº Docker Config çš„ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒ[æˆ‘çš„è¿™ç¯‡æ–‡ç« ](/posts/docker-swarm-service-config)ã€‚

å¦å¤–è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–å­˜å‚¨æœåŠ¡ï¼ˆå¦‚ `OSS`ï¼‰æ¥ä»£æ›¿æœ¬åœ° `git pull` çš„æ–¹å¼æ›´æ–°é…ç½®æ–‡ä»¶ï¼Œå½“é…ç½®æ–‡ä»¶æ›´æ–°æ—¶è‡ªåŠ¨æ¨é€åˆ° OSSï¼Œç„¶ååœ¨æœåŠ¡å™¨æŒ‚è½½ OSS åˆ°æœ¬åœ°ç›®å½•å³å¯ã€‚è¿™æ ·æœåŠ¡å™¨åªéœ€è¦æœ‰ OSS çš„è®¿é—®æƒé™å³å¯ï¼Œè¿™åœ¨åŒä¸€ä¸ªäº‘æœåŠ¡å•†ä¸‹å¾ˆå®¹æ˜“åšåˆ°ï¼Œè€Œä¸”æ›´åˆ©äºæ‰©å®¹ã€‚

ä¸€ä¸ªè‡ªåŠ¨æ¨é€é…ç½®æ–‡ä»¶åˆ° OSS çš„ Workflowï¼š

```yaml title=".github/workflows/upload.yaml" {23}
name: Upload manifests
on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1

      - name: Setup OSS
        uses: manyuanrong/setup-ossutil@v3.0
        with:
          endpoint: YOUR_OSS_ENDPOINT.aliyuncs.com
          access-key-id: ${{ secrets.ALIYUN_KEY }}
          access-key-secret: ${{ secrets.ALIYUN_SECRET }}

      - name: Upload to OSS
        run: |
          # clear uploads
          rm -rf ./.git
          # upload to oss
          ossutil sync ./ oss://YOUR_OSS_BUCKET/ --force --update --delete
```

## æ”¯æŒå›æ»šé‡å¯ç­‰æ“ä½œ

å†™ä¸€ä¸ª `service.sh` è„šæœ¬ï¼Œæ ¹æ®ä¸åŒçš„å‚æ•°æ‰§è¡Œä¸åŒçš„æ“ä½œï¼Œä¾‹å¦‚ï¼š

```sh title="service.sh"
#!/bin/bash
set -e

SERVICE="$1"
LOCK_FILE="/tmp/deploy-$SERVICE.lock"
[[ ${FLOCKER} != "$0" ]] && exec env FLOCKER="$0" flock -x -w 10 "$LOCK_FILE" "$0" "$@" || :

function deploy() {
  docker stack deploy -c docker-compose.yaml --with-registry-auth ${SERVICE}-stack
}

function restart() {
  docker service update --quiet --force "$service"
}

function rollback() {
  docker service rollback --quiet "$service"
}

case "$2" in
    deploy)
        deploy
        ;;
    restart)
        restart
        ;;
    rollback)
        rollback
        ;;
    *)
        echo "Usage: $0 {deploy|restart|rollback}"
        exit 1
esac
```

ä½¿ç”¨æ–¹æ³•ï¼š

```bash
# éƒ¨ç½²
./service.sh YOUR_SERVICE deploy

# é‡å¯
./service.sh YOUR_SERVICE restart

# å›æ»š
./service.sh YOUR_SERVICE rollback
```

ç„¶ååœ¨ Workflow ä¸­ä½¿ç”¨ SSH ç™»å½•åˆ°æœåŠ¡å™¨ä¸Šæ‰§è¡Œè¿™ä¸ªè„šæœ¬å³å¯ï¼š

```yaml title=".github/workflows/deploy.yaml" {11-19} {28-29}
name: Deploy

on:
  # æ”¯æŒæ‰‹åŠ¨éƒ¨ç½²
  workflow_dispatch:
    inputs:
      service:
        description: "The service you want to deploy"
        required: true
        type: string
      operation:
        description: "The operation you want to perform"
        required: true
        default: "deploy"
        type: choice
        options:
          - deploy
          - rollback
          - restart

    steps:
      # ä½¿ç”¨ SSH ç™»å½•åˆ°æœåŠ¡å™¨
      - name: Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          script: |
            cd /path/to/your/repo
            chmod u+x ./service.sh
            exec ./service.sh ${{ inputs.service }} ${{ inputs.operation }}
```

## å¤šç¯å¢ƒéƒ¨ç½²

Testing ç¯å¢ƒå¾€å¾€éƒ¨ç½²åœ¨å•ç‹¬çš„æœåŠ¡å™¨ï¼Œåªéœ€è¦æ ¹æ®ç¯å¢ƒé€‰æ‹© SSH ç™»å½•åˆ°ä¸åŒæœåŠ¡å™¨å³å¯ã€‚

```yaml title=".github/workflows/deploy.yaml" {7-14} {32-35}
name: Deploy

on:
  # æ”¯æŒæ‰‹åŠ¨éƒ¨ç½²
  workflow_dispatch:
    inputs:
      env:
        description: "The environment you want to deploy"
        required: true
        default: "testing"
        type: choice
        options:
          - product
          - testing
      service:
        description: "The service you want to deploy"
        required: true
        type: string
      version:
        description: "The service version you want to deploy"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-20.04
    steps:
      # ä½¿ç”¨ SSH ç™»å½•åˆ°æœåŠ¡å™¨
      - name: Deploy ${{ inputs.service }}@${{ inputs.version }}
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ inputs.env == 'product' && secrets.SSH_HOST || secrets.TESTING_SSH_HOST }}
          username: ${{ inputs.env == 'product' && secrets.SSH_USER || secrets.TESTING_SSH_USER }}
          key: ${{ inputs.env == 'product' && secrets.SSH_KEY || secrets.TESTING_SSH_KEY }}
          port: ${{ inputs.env == 'product' && secrets.SSH_PORT || secrets.TESTING_SSH_PORT }}
          script_stop: true
          # æ‰§è¡Œå®é™…çš„éƒ¨ç½²è„šæœ¬ï¼Œå¦‚éƒ¨ç½² docker service
          script: |
            sudo docker service update --image ${{ inputs.version }} ${{ inputs.service }}
```

## Workflow é‡ç”¨

æœ‰å¤šä¸ªæœåŠ¡éœ€è¦ç®¡ç†æ—¶ï¼Œå¦‚æœæ¯ä¸ªæœåŠ¡çš„éƒ¨ç½²è„šæœ¬ç›¸åŒè¿˜å¥½ï¼Œç”¨ä¸Šé¢çš„ Workflow ä¼ å…¥ä¸åŒçš„ service å°±å¯ä»¥äº†ã€‚

ä½†å¦‚æœæœ‰äº›æœåŠ¡çš„éƒ¨ç½²æµç¨‹æ¯”è¾ƒç‰¹æ®Šï¼Œå¿…é¡»å•ç‹¬ä¸ºæ¯ä¸ªæœåŠ¡ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥æ‰§è¡Œéƒ¨ç½²ã€å›æ»šæ“ä½œçš„è¯ï¼Œæ¯ä¸ª Workflow éƒ½å†™è¿™ä¹ˆå†—é•¿å°±æœ‰äº›éš¾ä»¥ç»´æŠ¤äº†ï¼Œè¿™å°±è¦ç”¨åˆ° Workflow çš„ **é‡ç”¨** åŠŸèƒ½äº†ã€‚

é‡ç”¨å°±æ˜¯ç”¨ç±»ä¼¼å‡½æ•°è°ƒç”¨çš„æ–¹å¼å»è°ƒç”¨ä¸€ä¸ª Workflowï¼Œä¹Ÿå°±æ˜¯ Workflow çš„å°è£…ã€‚

å¯ä»¥è¿™æ ·å°† SSH ç™»å½•æ‰§è¡Œå’ŒæœåŠ¡ç‹¬ç«‹é…ç½®åˆ†å‰²å¼€ï¼š

```yaml title=".github/workflows/deploy_server.yaml" {17}
name: Deploy Server

on:
  workflow_dispatch:
    inputs:
      env:
        description: "The environment you want to deploy"
        required: true
        default: "testing"
        type: choice
        options:
          - product
          - testing

jobs:
  deploy:
    uses: ./.github/workflows/deploy.yaml
    secrets: inherit
    with:
      env: ${{ inputs.env || (github.ref_name == 'master' && 'testing' || github.ref_name) }}
      dir: /path/to/your/server
      operation: ${{ inputs.operation }}
```

```yaml title=".github/workflows/deploy.yaml" {4} {34-36}
name: Deploy

on:
  workflow_call:
    inputs:
      env:
        description: "Deploy environment"
        type: string
        required: true
      dir:
        description: "Working directory"
        type: string
        required: true
      operation:
        type: string
        required: false
        default: deploy

jobs:
  deploy:
    runs-on: ubuntu-20.04
    steps:
      # ä½¿ç”¨ SSH ç™»å½•åˆ°æœåŠ¡å™¨
      - name: Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ inputs.env == 'product' && secrets.SSH_HOST || secrets.TESTING_SSH_HOST }}
          username: ${{ inputs.env == 'product' && secrets.SSH_USER || secrets.TESTING_SSH_USER }}
          key: ${{ inputs.env == 'product' && secrets.SSH_KEY || secrets.TESTING_SSH_KEY }}
          port: ${{ inputs.env == 'product' && secrets.SSH_PORT || secrets.TESTING_SSH_PORT }}
          script_stop: true
          # æ‰§è¡Œå®é™…çš„éƒ¨ç½²è„šæœ¬ï¼Œå¦‚éƒ¨ç½² docker service
          script: |
            cd ${{ inputs.dir }}
            chmod u+x ./service.sh
            exec ./service.sh ${{ inputs.operation }}
```

## æ„å»ºåè‡ªåŠ¨éƒ¨ç½²

æƒ³è¦å®ç°æ„å»ºåè‡ªåŠ¨éƒ¨ç½²åˆ° Testing ç¯å¢ƒï¼Œå¦‚æœæ‰€æœ‰ Workflow éƒ½åœ¨åŒä¸€ä¸ªä»“åº“ä¸‹ï¼Œé‚£ç›´æ¥é‡ç”¨å³å¯ã€‚

å¦‚æœä¸å†åŒä¸€ä¸ªä»“åº“ä¸‹ï¼Œå¯ä»¥ç”¨ `repository_dispatch` çš„æ–¹å¼è°ƒç”¨å¦ä¸€ä¸ªä»“åº“ä¸‹çš„ Workflowã€‚

è¢«è°ƒç”¨ä»“åº“çš„ Workflowï¼š

```yaml title=".github/workflows/deploy.yaml" {4-5}
name: Deploy

on:
  repository_dispatch:
    types: [deploy_service]
# ...
```

æ„å»ºäº§ç‰©çš„ Workflowï¼š

```yaml title=".github/workflows/build.yaml" {11-28}
name: Build

on:
  push:
    branches: [main, master]

jobs:
  build:
    # ...

  deploy:
    runs-on: ubuntu-latest
    needs: [build] # ä¾èµ– build ä»»åŠ¡å®Œæˆ
    steps:
      - name: Notify
        uses: actions/github-script@v7
        with:
          # éœ€è¦é…ç½® PAT ä»¥è·å–å¦å¤–ä¸€ä¸ªä»“åº“çš„æƒé™
          github-token: ${{ secrets.PENSONAL_ACCESS_TOKEN }}
          # è°ƒç”¨ Github API å‘é€ repository_dispatch äº‹ä»¶
          # see syntax on https://octokit.github.io/rest.js/v20
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: 'YOUR_DEPLOY_REPO_OWNER',
              repo: 'YOUR_DEPLOY_REPO_NAME',
              event_type: 'deploy_service',
              client_payload: {},
            });
```

## éƒ¨ç½²åå‘¨çŸ¥å·¥ä½œç¾¤

[`github-script`](https://github.com/actions/github-script) è¿™ä¸ª Action å¯ä»¥æ‰§è¡Œ js ä»£ç ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ç”¨æ”¯æŒ API çš„ç¾¤æœºå™¨äººæ¥å‘é€é€šçŸ¥ã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç å‘é€é€šçŸ¥åˆ° Lark ç¾¤ï¼š

```yaml title=".github/workflows/notify.yaml" {27-28}
on:
  workflow_dispatch:
    inputs:
      service:
        description: "Repo owner"
        type: string
        required: true
      tag_name:
        description: "Tag name"
        default: v1.x.x
        type: string
        required: true
      message:
        description: "Message"
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Notify to Lark
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/workflows/scripts/send_lark_card.js')
            await script({github, context, core})
        env:
          APP_ID: ${{ secrets.LARK_APP_ID }}
          APP_SECRET: ${{ secrets.LARK_APP_SECRET }}
          RECEIVE_TYPE: chat_id
          RECEIVE_ID: ${{ vars.LARK_NOTIFY_ID }}
          # Build Lark Card on https://open.feishu.cn/tool/cardbuilder
          CARD_BODY: |
            {
              "config": {
                "wide_screen_mode": true
              },
              "header": {
                "template": "blue",
                "title": {
                  "content": "ã€CICDã€‘${{ inputs.service }} æœåŠ¡æ„å»ºé€šçŸ¥",
                  "tag": "plain_text"
                }
              },
              "elements": [
                {
                  "fields": [
                    {
                      "is_short": true,
                      "text": {
                        "content": "**ç‰ˆæœ¬**\n${{ inputs.tag_name }}",
                        "tag": "lark_md"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "content": "**æ“ä½œäºº**\n${{ github.actor }}",
                        "tag": "lark_md"
                      }
                    }
                  ],
                  "tag": "div"
                },
                {
                  "tag": "div",
                  "text": {
                    "content": ${{ inputs.message }},
                    "tag": "lark_md"
                  }
                }
              ]
            }
```

è¿™ä¸ª Workflow ä¼šé€šè¿‡ Lark æœºå™¨äººå‘é€ä¸€å¼ æ¶ˆæ¯å¡ç‰‡ï¼Œå‘é€æ¶ˆæ¯çš„ä»£ç å¦‚ä¸‹ï¼š

```javascript title=".github/workflows/scripts/send_lark_card.js"
module.exports = async ({ github, context, core }) => {
  const { APP_ID, APP_SECRET, RECEIVE_TYPE, RECEIVE_ID, CARD_BODY } = process.env;

  // Get app access token
  const { tenant_access_token } = await fetch("https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      app_id: APP_ID,
      app_secret: APP_SECRET,
    }),
  }).then(async response => {
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}. Message: ${await response.text()}`);
    }
    return response.json();
  });

  // Send card
  await fetch(`https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=${RECEIVE_TYPE}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${tenant_access_token}`,
    },
    body: JSON.stringify({
      receive_id: RECEIVE_ID,
      content: CARD_BODY,
      msg_type: "interactive",
    }),
  }).then(async response => {
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}. Message: ${await response.text()}`);
    }
    return response.json();
  });
};
```

å½“ç„¶å¡ç‰‡ä¹Ÿå¯ä»¥åœ¨ Workflow ä¸­é€šè¿‡å˜é‡åšä¸€äº›ç¾åŒ–ï¼Œæµ‹è¯•æ•ˆæœï¼š

![Lark Notify](@assets/github-workflow-cicd/image-1.png)

---
title: å¦‚ä½•åŠ¨æ€è°ƒæ•´ Utterances è¯„è®ºç³»ç»Ÿçš„ä¸»é¢˜
date: 2023-10-25T18:47:00+08:00
tags: [Astro, React]
---

## ç›®å½•

## è§£å†³æ€è·¯

æœ€è¿‘åœ¨ç»™æˆ‘çš„åšå®¢æ¥å…¥è¯„è®ºç³»ç»Ÿï¼Œå› ä¸ºåªè€ƒè™‘åŸºäº Github Issue çš„è¯„è®ºæ¡†æ¶ï¼Œæœ€åå†³å®šåœ¨ [Gitalk](https://github.com/gitalk/gitalk) å’Œ [Utterances](https://github.com/utterance/utterances) ä¸­é€‰ä¸€ä¸ªã€‚ä¹‹å‰ç”¨è¿‡ä¸€æ®µæ—¶é—´ Gitalkï¼Œå½“æ—¶æ²¡æœ‰è®¾ç½®æ¯ç¯‡æ–‡ç« çš„ idï¼Œç»“æœç°åœ¨æ›´æ”¹åŸŸåä»¥åå…¨éƒ½è¯†åˆ«ä¸äº†äº†ï¼ŒæŠ˜è…¾äº†ä¸€ä¼šå„¿æ²¡è§£å†³ï¼Œå†åŠ ä¸Šå®ƒå¯¹ ts å’Œ React çš„æ”¯æŒå¹¶ä¸å¥½ï¼Œæ‰€ä»¥å†³å®šå°è¯•ä¸€ä¸‹ Utterancesã€‚

`Utterances` ç”¨åœ¨é™æ€åšå®¢ä¸Šè¿˜æ˜¯éå¸¸ç®€å•æ˜“ç”¨çš„ï¼Œä¸€ä¸ª script æ ‡ç­¾å°±å¯ä»¥è§£å†³ï¼Œå®ƒè¿˜åšäº†ä¸€ä¸ª[é…ç½®ç”Ÿæˆå™¨](https://utteranc.es/)ï¼Œåªéœ€è¦æŠŠä¸‹é¢çš„ä»£ç åŠ å…¥åˆ°ç½‘é¡µä¸­å°±å¯ä»¥ç”¨äº†

```html
<script
  src="https://utteranc.es/client.js"
  repo="owner/repo"
  issue-term="pathname"
  label="âœ¨ğŸ’¬âœ¨"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
```

å› ä¸ºæˆ‘çš„åšå®¢æœ‰åˆ‡æ¢ `light` å’Œ `dark` ä¸»é¢˜è‰²çš„åŠŸèƒ½ï¼Œäºæ˜¯æƒ³è®© Utterances ä¹Ÿéšåšå®¢ä¸»é¢˜ä¸€èµ·å˜åŒ–ã€‚æƒ³å®ç°çš„æœ€ç»ˆæ•ˆæœæ˜¯è¿™æ ·çš„ï¼š

![æœ€ç»ˆæ•ˆæœ](@assets/images/2023/dynamic-utterances-theme/preview.gif)

æˆ‘æƒ³åº”è¯¥æœ‰äººå’Œæˆ‘é‡åˆ°ä¸€æ ·çš„é—®é¢˜ï¼Œäºæ˜¯åœ¨ utterances çš„ [issue#549](https://github.com/utterance/utterances/issues/549#issuecomment-907606127) é‡Œæ‰¾åˆ°äº†ä¸€ä¸ªè§£å†³æ–¹æ³•ï¼Œä½¿ç”¨ `iframe.postMessage()` ç»™è¯„è®ºå­çª—å£å‘é€æ¶ˆæ¯ï¼Œå¯ä»¥å®ç°åŠ¨æ€å˜åŒ–ã€‚

ç¡®å®æ˜¯ä¸é”™çš„è§£å†³åŠæ³•ï¼Œä½†æ˜¯å¦‚ä½•åœ¨é¡µé¢ç¬¬ä¸€æ¬¡åŠ è½½çš„æ—¶å€™å°±è®¾ç½®æ­£ç¡®çš„ä¸»é¢˜å‘¢ï¼Ÿserver æ¸²æŸ“æ—¶è¿˜ä¸çŸ¥é“ client ä½¿ç”¨ä»€ä¹ˆä¸»é¢˜ï¼Œæ‰€ä»¥æ²¡åŠæ³•ç›´æ¥åˆå§‹åŒ– script æ ‡ç­¾é‡Œçš„å˜é‡ã€‚éš¾é“åªèƒ½å†™ä¸€æ®µ client jsï¼ŒåŠ¨æ€ç”Ÿæˆè¿™ä¸ª script æ ‡ç­¾å—ï¼Ÿæ„Ÿè§‰æœ‰äº›ä¸‘é™‹ã€‚

äºæ˜¯æˆ‘å†³å®šçœ‹çœ‹å®ƒçš„ script åœ¨åšä»€ä¹ˆï¼Œå¯ä»¥çœ‹åˆ° `theme` æ˜¯å®ƒçš„ä¸€ä¸ª attributeï¼ŒæŠŠè„šæœ¬ä¸‹è½½ä¸‹æ¥å‘ç°å…¶å®å®ƒæ‹¼å‡‘äº†ä¸€ä¸ª `iframe` çš„ url é“¾æ¥ï¼Œç„¶åæ’å…¥åˆ° document ä¸­ï¼Œåƒä¸‹é¢è¿™æ®µä»£ç ã€‚

```html
<iframe
  className="utterances-frame"
  src="https://xxxxxxx.com?theme=github-light"
  scrolling="no"
  loading="lazy"
></iframe>
```

è¿™ä¸ª theme æ˜¯ iframe url çš„ä¸€ä¸ªæŸ¥è¯¢å‚æ•°ï¼Œæ‰€ä»¥åªè¦æ‹¼å‡‘å‡ºç¬¦åˆè§„åˆ™çš„é“¾æ¥å°±å¯ä»¥é¿å…ä½¿ç”¨å®ƒçš„ script sdk äº†ï¼Œç„¶åå°±å¯ä»¥å°† js å˜é‡æ’å…¥åˆ° iframe src é‡Œã€‚

é‚£ç›´æ¥ä¿®æ”¹è¿™ä¸ª url çš„å‚æ•°æ˜¯ä¸æ˜¯å°±å¯ä»¥åšåˆ°åŠ¨æ€ä¿®æ”¹ä¸»é¢˜äº†ï¼Ÿè™½ç„¶å¯ä»¥ï¼Œä½†æ˜¯ url å˜åŒ–ä¼šå¯¼è‡´ iframe æ•´ä½“é‡æ–°åŠ è½½ï¼Œå¯¹æˆ‘è¿™ç§å¼ºè¿«ç—‡æ¥è¯´ä¸èƒ½æ¥å—ï¼Œè¿˜æ˜¯è¦ç”¨ `iframe.postMessage()` æ¥å®ç°åŠ¨æ€ä¿®æ”¹ã€‚

## React ç‰ˆæœ¬å®ç°

äºæ˜¯å®ç°äº†ä¸€ä¸ª React ç‰ˆæœ¬çš„åŠ¨æ€ä¸»é¢˜ `utterances`ï¼Œè´´ä»£ç 

```jsx
// Utterances.tsx
import { useEffect, useMemo, useRef, useState } from "react";
import "./Utterances.css";

// NOTICE: è‡ªå®šä¹‰é…ç½®é¡¹
const config = {
  repo: "YOUR/REPO",
  "issue-term": "pathname",
  label: "âœ¨ğŸ’¬âœ¨",
  crossorigin: "anonymous",
};

export default function UtterancesComment() {
  const elementRef = useRef<HTMLIFrameElement>(null);
  const [height, setHeight] = useState<number>();

  const changeTheme = (theme: string) => {
    elementRef.current?.contentWindow?.postMessage(
      {
        type: "set-theme",
        theme: theme,
      },
      "https://utteranc.es"
    );
  };

  useEffect(() => {
    window.addEventListener("message", (e: any) => {
      if (e.origin !== "https://utteranc.es") return;
      if (e.data && e.data.type === "resize" && e.data.height) {
        setHeight(e.data.height);
      }
    });

    // NOTICE: ç›‘å¬ä¸»é¢˜å˜åŒ–
    document.addEventListener(
      "themechange",
      (e: CustomEvent<"light" | "dark">) => {
        changeTheme(e.detail === "dark" ? "github-dark" : "github-light");
      }
    );
  }, []);

  const params = useMemo(() => {
    // NOTICE: åˆæ¬¡åŠ è½½æ—¶è·å–ä¸»é¢˜
    const initTheme =
      document.firstElementChild?.getAttribute("data-theme") === "dark"
        ? "github-dark"
        : "github-light";

    const url = new URL(location.href);
    const desc = document.querySelector("meta[name='description']");
    const ogTitle = document.querySelector(
      "meta[property='og:title'],meta[name='og:title']"
    );

    const options: Record<string, any> = {
      ...config,
      src: "https://utteranc.es/client.js",
      theme: initTheme,
      url: url.origin + url.pathname + url.search,
      origin: url.origin,
      pathname:
        url.pathname.length < 2
          ? "index"
          : url.pathname.substr(1).replace(/\.\w+$/, ""),
      title: document.title,
      description: desc?.getAttribute("content") || "",
      "og:title": ogTitle?.getAttribute("content") || "",
    };
    return new URLSearchParams(options);
  }, []);
  return (
    <div className="utterances" style={{ height: `${height}px` }}>
      <iframe
        ref={elementRef}
        className="utterances-frame"
        title="Comments"
        src={`https://utteranc.es/utterances.html?${params}`}
        scrolling="no"
        loading="lazy"
      ></iframe>
    </div>
  );
}

```

```css
/* Utterances.css */
.utterances {
  position: relative;
  box-sizing: border-box;
  width: 100%;
  max-width: 760px;
  margin-left: auto;
  margin-right: auto;
}
.utterances-frame {
  color-scheme: light;
  position: absolute;
  left: 0;
  right: 0;
  width: 1px;
  min-width: 100%;
  max-width: 100%;
  height: 100%;
  border: 0;
}
```

ä½¿ç”¨æ—¶åªéœ€è¦æŠŠè¿™ä¸ªç»„ä»¶æ”¾åˆ°éœ€è¦çš„åœ°æ–¹å°±å¯ä»¥äº†

```jsx
import UtterancesComment from "@components/Utterances";

<UtterancesComment />;
```

å…¶ä¸­å†™äº† NOTICE æ³¨é‡Šçš„å‡ å¤„ä»£ç æ˜¯éœ€è¦æ ¹æ®è‡ªå·±çš„æƒ…å†µæ”¹çš„ï¼Œæˆ‘ç”¨çš„æ˜¯ `astro` æ¡†æ¶ï¼Œä¿®æ”¹ä¸»é¢˜ä¼šè§¦å‘ä¸€ä¸ª `CustomEvent`ï¼Œæ‰€ä»¥åœ¨ `React` ä»£ç é‡Œæ˜¯ç›‘å¬äº†è¿™ä¸ªäº‹ä»¶æ¥å¤„ç†çš„ã€‚

## Astro ç‰ˆæœ¬å®ç°

åœ¨å†™ React è¿™æ®µä»£ç çš„æ—¶å€™æˆ‘å‘ç° `utterances` åˆå§‹åŒ–å®Œæˆåä¼šç»™ `window` å‘é€ä¸€ä¸ª `resize` æ¶ˆæ¯ï¼Œé‚£å…¶å®å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ¶ˆæ¯åˆ¤æ–­å®ƒåˆå§‹åŒ–å®Œæˆäº†ï¼Œä¸éœ€è¦åœ¨ server ç«¯çŸ¥é“åˆå§‹åŒ–ä¸»é¢˜ã€‚

äºæ˜¯åˆå†™äº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ `astro` å®ç°ï¼Œè´´ä»£ç ï¼š

```astro
<script
  src="https://utteranc.es/client.js"
  repo="YOUR/repo"
  issue-term="pathname"
  label="âœ¨ğŸ’¬âœ¨"
  theme="github-light"
  crossorigin="anonymous"
  async></script>

<script>
  function changeUtterancesTheme(theme: "github-dark" | "github-light") {
    if (document.querySelector(".utterances-frame")) {
      const message = {
        type: "set-theme",
        theme: theme,
      };
      const iframe = document.querySelector(
        ".utterances-frame"
      ) as HTMLIFrameElement;
      try {
        iframe?.contentWindow?.postMessage(message, "https://utteranc.es");
      } catch {}
    }
  }

  window.addEventListener("message", (e: any) => {
    if (e.origin !== "https://utteranc.es") return;
    if (e.data && e.data.type === "resize") {
      // reset theme
      changeUtterancesTheme(
        document.firstElementChild?.getAttribute("data-theme") === "dark"
          ? "github-dark"
          : "github-light"
      );
    }
  });

  document.addEventListener(
    "themechange",
    (e: CustomEvent<"light" | "dark">) => {
      changeUtterancesTheme(
        e.detail === "dark" ? "github-dark" : "github-light"
      );
    }
  );
</script>
```
